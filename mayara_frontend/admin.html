<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Mayara Burguer's</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }

        .header {
            background-color: #343a40;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .pedido {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: .5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .pedido-header {
            background-color: #f1f1f1;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .pedido-body {
            padding: 1.25rem;
        }

        .pedido-footer {
            background-color: #f1f1f1;
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #dee2e6;
            font-weight: bold;
            text-align: right;
        }
        
        .item-detalhes {
            font-size: 0.9rem;
            color: #6c757d;
            margin-left: 15px;
        }
    </style>
</head>

<body>

    <header class="header">
        <h1><i class="fas fa-cogs"></i> Painel de Controle - Pedidos</h1>
    </header>

    <main class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4">Histórico de Pedidos</h2>
            <button id="btn-recarregar" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Recarregar Pedidos
            </button>
        </div>
        
        <div id="pedidos-container">
            <p class="text-center">Carregando pedidos...</p>
        </div>
    </main>

    <footer class="text-center text-muted py-3">
        <p>© 2025 Mayara Burguer's</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // URL base do seu servidor backend. Altere se necessário.
            const BASE_URL = 'https://mayara-backend-servidor.onrender.com';
            
            // Mapeamento dos elementos HTML que serão manipulados
            const pedidosContainer = document.getElementById('pedidos-container');
            const btnRecarregar = document.getElementById('btn-recarregar');

            /**
             * Função principal para buscar e renderizar os pedidos.
             * Inclui tratamento robusto de erros de rede e de servidor.
             */
            async function carregarPedidos() {
                pedidosContainer.innerHTML = '<p class="text-center">Buscando novos pedidos...</p>';

                try {
                    const response = await fetch(`${BASE_URL}/api/pedidos`);

                    // VERIFICAÇÃO ESSENCIAL: Checa se a resposta da requisição foi bem-sucedida (status entre 200 e 299).
                    if (!response.ok) {
                        // Se a resposta for um erro (como 429 ou 500), lança um novo erro para ser capturado pelo bloco 'catch'.
                        throw new Error(`Erro do servidor: ${response.status} - ${response.statusText}`);
                    }

                    // Tenta converter o corpo da resposta para o formato JSON.
                    const pedidos = await response.json();
                    
                    // Se a conversão for bem-sucedida, chama a função para renderizar os dados na tela.
                    renderizarPedidos(pedidos);

                } catch (error) {
                    console.error("Falha ao buscar ou processar os pedidos:", error);
                    
                    // Em caso de qualquer erro na busca ou processamento, exibe uma mensagem amigável na tela.
                    pedidosContainer.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <strong>Ops! Falha ao carregar os pedidos.</strong>
                            <p>Pode ser um problema de conexão ou o servidor está ocupado. Tente recarregar.</p>
                            <p class="small mb-0">Detalhe do erro: ${error.message}</p>
                        </div>`;
                }
            }

            /**
             * Função responsável por receber uma lista (array) de objetos de pedido e transformá-la em elementos HTML.
             * @param {Array} pedidos - A lista de pedidos que foi recebida da API.
             */
            function renderizarPedidos(pedidos) {
                // Primeiro, limpa qualquer conteúdo existente no container.
                pedidosContainer.innerHTML = '';

                // Se a lista de pedidos não existir ou estiver vazia, exibe uma mensagem informativa.
                if (!pedidos || pedidos.length === 0) {
                    pedidosContainer.innerHTML = '<p class="text-center text-muted">Nenhum pedido encontrado no histórico.</p>';
                    return; // Encerra a execução da função, pois não há nada a renderizar.
                }

                // Utiliza o método 'forEach' para iterar sobre cada objeto 'pedido' dentro da lista 'pedidos'.
                pedidos.forEach(pedido => {
                    // Formata a data e hora para o padrão brasileiro (dd/mm/aaaa, hh:mm:ss).
                    const dataHora = new Date(pedido.data_hora).toLocaleString('pt-BR');

                    // Formata o valor total para a moeda brasileira (Reais - BRL).
                    const valorTotal = parseFloat(pedido.valor_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    let itensHtml = '';
                    // Verifica se o pedido possui a lista de itens e se ela não está vazia.
                    if (pedido.itens_do_pedido && pedido.itens_do_pedido.length > 0) {
                        pedido.itens_do_pedido.forEach(item => {
                            // Constrói a string HTML para cada item do pedido.
                            itensHtml += `
                                <li>
                                    <strong>${item.quantidade}x ${item.nome_produto}</strong>
                                    <div class="item-detalhes">
                                        ${item.observacoes ? `<div><em>Obs: ${item.observacoes}</em></div>` : ''}
                                    </div>
                                </li>`;
                        });
                    } else {
                        itensHtml = '<li>Nenhum item detalhado foi registrado para este pedido.</li>';
                    }

                    // Cria um novo elemento 'div' que representará o card do pedido.
                    const pedidoCard = document.createElement('div');
                    pedidoCard.className = 'pedido'; // Adiciona a classe CSS para estilização.
                    
                    // Define o conteúdo HTML interno do card do pedido, usando os dados formatados.
                    pedidoCard.innerHTML = `
                        <div class="pedido-header d-flex justify-content-between">
                            <span>Pedido #${pedido.id}</span>
                            <span>${dataHora}</span>
                        </div>
                        <div class="pedido-body">
                            <p><strong>Cliente:</strong> ${pedido.cliente_nome}</p>
                            <p><strong>Telefone:</strong> ${pedido.cliente_telefone}</p>
                            <p><strong>Entrega:</strong> ${pedido.tipo_entrega === 'delivery' ? `Delivery - ${pedido.cliente_endereco}` : 'Retirada no Local'}</p>
                            <h6>Itens:</h6>
                            <ul>
                                ${itensHtml}
                            </ul>
                        </div>
                        <div class="pedido-footer">
                            <span>Total: ${valorTotal}</span>
                        </div>
                    `;
                    
                    // Adiciona o card recém-criado como um filho do container principal na página.
                    pedidosContainer.appendChild(pedidoCard);
                });
            }

            // Adiciona um "ouvinte" de eventos para o clique no botão de recarregar.
            btnRecarregar.addEventListener('click', carregarPedidos);

            // Chama a função para carregar os pedidos pela primeira vez, assim que a página é aberta.
            carregarPedidos();
        });
    </script>
    </body>
</html>
