
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Mayara Burguer's</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header { background-color: #343a40; color: white; padding: 1.5rem; text-align: center; }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { color: #000; font-weight: bold; border-color: #dee2e6 #dee2e6 #fff; }
        .tab-content { background-color: #fff; padding: 2rem; border: 1px solid #dee2e6; border-top: 0; }
        .btn-acao { width: 38px; height: 38px; }
        .form-check-input { width: 1.5em; height: 1.5em; }
        .sub-header { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
    </style>
</head>
<body>

    <header class="header">
        <h1><i class="fas fa-cogs"></i> Painel de Controle</h1>
    </header>

    <main class="container my-4">
        <ul class="nav nav-tabs" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos-pane" type="button"><i class="fas fa-receipt"></i> Pedidos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos-pane" type="button"><i class="fas fa-hamburger"></i> Produtos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias-pane" type="button"><i class="fas fa-tags"></i> Categorias</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="ingredientes-tab" data-bs-toggle="tab" data-bs-target="#ingredientes-pane" type="button"><i class="fas fa-carrot"></i> Ingredientes/Adicionais</button></li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <div class="tab-pane fade show active" id="pedidos-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Histórico de Pedidos</h2><button id="btn-recarregar-pedidos" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync-alt"></i> Recarregar</button></div>
                <div id="pedidos-container"></div>
            </div>
            <div class="tab-pane fade" id="produtos-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Gerenciar Produtos</h2><button id="btn-adicionar-produto" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Produto</button></div>
                <div id="produtos-container" class="table-responsive"></div>
            </div>
            <div class="tab-pane fade" id="categorias-pane" role="tabpanel">
                 <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Gerenciar Categorias</h2><button id="btn-adicionar-categoria" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Categoria</button></div>
                <div id="categorias-container" class="table-responsive"></div>
            </div>
            <div class="tab-pane fade" id="ingredientes-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h4">Gerenciar Ingredientes e Adicionais</h2>
                    <button id="btn-adicionar-ingrediente" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Novo Item</button>
                </div>
                <h5 class="sub-header">Adicionais (Vendidos Separadamente)</h5>
                <div id="adicionais-container" class="table-responsive mb-5"></div>
                <h5 class="sub-header">Ingredientes de Preparo (Estoque Interno)</h5>
                <div id="ingredientes-preparo-container" class="table-responsive"></div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="form-produto"><div class="modal-header"><h5 class="modal-title" id="modalProdutoTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="produto-id"><div class="mb-3"><label for="produto-nome" class="form-label">Nome</label><input type="text" class="form-control" id="produto-nome" required></div><div class="mb-3"><label for="produto-descricao" class="form-label">Descrição</label><textarea class="form-control" id="produto-descricao"></textarea></div><div class="row"><div class="col-md-6 mb-3"><label for="produto-preco" class="form-label">Preço Base (R$)</label><input type="number" step="0.01" class="form-control" id="produto-preco" required></div><div class="col-md-6 mb-3"><label for="produto-categoria" class="form-label">Categoria</label><select class="form-select" id="produto-categoria" required></select></div></div><div class="mb-3"><label for="produto-imagem" class="form-label">URL da Imagem</label><input type="url" class="form-control" id="produto-imagem"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>
    
    <div class="modal fade" id="modalCategoria" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="form-categoria"><div class="modal-header"><h5 class="modal-title" id="modalCategoriaTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="categoria-id"><div class="mb-3"><label for="categoria-nome" class="form-label">Nome da Categoria</label><input type="text" class="form-control" id="categoria-nome" required></div><div class="row"><div class="col-md-6 mb-3"><label for="categoria-ordem" class="form-label">Ordem de Exibição</label><input type="number" class="form-control" id="categoria-ordem" required></div></div><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" role="switch" id="categoria-permite-adicionais"><label class="form-check-label" for="categoria-permite-adicionais">Permitir Adicionais?</label></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>
    
    <div class="modal fade" id="modalIngrediente" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="form-ingrediente"><div class="modal-header"><h5 class="modal-title" id="modalIngredienteTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="ingrediente-id"><div class="mb-3"><label for="ingrediente-nome" class="form-label">Nome</label><input type="text" class="form-control" id="ingrediente-nome" required></div><div class="row"><div class="col-md-6 mb-3"><label for="ingrediente-unidade" class="form-label">Unidade</label><input type="text" class="form-control" id="ingrediente-unidade"></div><div class="col-md-6 mb-3"><label for="ingrediente-estoque" class="form-label">Estoque</label><input type="number" class="form-control" id="ingrediente-estoque" required></div></div><hr><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="ingrediente-pode-adicional"><label class="form-check-label" for="ingrediente-pode-adicional">É Adicional?</label></div><div id="campos-adicional" style="display:none;"><div class="row"><div class="col-md-6 mb-3"><label for="ingrediente-preco-adicional" class="form-label">Preço Adicional (R$)</label><input type="number" step="0.01" class="form-control" id="ingrediente-preco-adicional"></div><div class="col-md-6 mb-3"><label for="ingrediente-desconto-uso" class="form-label">Desconto Estoque</label><input type="number" step="1" class="form-control" id="ingrediente-desconto-uso"><small class="form-text text-muted">Qtd. por uso.</small></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_URL = 'https://mayara-backend-servidor.onrender.com';
        const modalProduto = new bootstrap.Modal(document.getElementById('modalProduto'));
        const modalIngrediente = new bootstrap.Modal(document.getElementById('modalIngrediente'));
        const modalCategoria = new bootstrap.Modal(document.getElementById('modalCategoria'));
        
        const containers = {
            pedidos: document.getElementById('pedidos-container'),
            produtos: document.getElementById('produtos-container'),
            categorias: document.getElementById('categorias-container'),
            adicionais: document.getElementById('adicionais-container'),
            ingredientesPreparo: document.getElementById('ingredientes-preparo-container')
        };
        
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`${BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    throw new Error(errorData.error || `Erro na rede: ${response.statusText}`);
                }
                if (response.status === 204) return { success: true };
                return await response.json();
            } catch (error) {
                console.error(`Falha na requisição para ${endpoint}:`, error);
                alert(`Erro: ${error.message}`);
                return null;
            }
        }
        
        async function carregarPedidos() {
            containers.pedidos.innerHTML = '<p>Carregando histórico de pedidos...</p>';
            const pedidos = await apiRequest('/api/pedidos');
            if (!pedidos) { containers.pedidos.innerHTML = '<p class="text-danger">Não foi possível carregar os pedidos.</p>'; return; }
            if (pedidos.length === 0) { containers.pedidos.innerHTML = '<p class="text-muted">Nenhum pedido encontrado.</p>'; return; }
            containers.pedidos.innerHTML = '';
            pedidos.forEach(pedido => {
                const dataHora = new Date(pedido.data_hora).toLocaleString('pt-BR');
                const valorTotal = parseFloat(pedido.valor_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                let itensHtml = (pedido.itens_do_pedido && pedido.itens_do_pedido.length > 0) ? `<ul>${pedido.itens_do_pedido.map(item => `<li>${item.quantidade}x ${item.nome_produto} ${item.observacoes ? `<em>(${item.observacoes})</em>` : ''}</li>`).join('')}</ul>` : '<p class="small text-muted">Sem detalhes de itens.</p>';
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `<div class="card-header d-flex justify-content-between"><strong>Pedido #${pedido.id}</strong><span class="text-muted">${dataHora}</span></div><div class="card-body"><p class="mb-1"><strong>Cliente:</strong> ${pedido.cliente_nome}</p><p class="mb-1"><strong>Endereço:</strong> ${pedido.tipo_entrega === 'delivery' ? pedido.cliente_endereco : 'Retirada no Balcão'}</p><hr><h6>Itens:</h6>${itensHtml}</div><div class="card-footer text-end"><strong>Total: ${valorTotal}</strong></div>`;
                containers.pedidos.appendChild(card);
            });
        }
        
        async function carregarProdutos() {
            containers.produtos.innerHTML = '<p>Carregando produtos...</p>';
            const produtos = await apiRequest('/api/produtos');
             if (!produtos) { containers.produtos.innerHTML = '<p class="text-danger">Não foi possível carregar os produtos.</p>'; return; }
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Categoria</th><th>Preço Base</th><th class="text-end">Ações</th></tr></thead><tbody>${produtos.map(p => `<tr data-produto='${JSON.stringify(p)}'><td>${p.nome}</td><td>${p.categorias.nome}</td><td>${parseFloat(p.preco_base).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-produto"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-produto" data-id="${p.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            containers.produtos.innerHTML = '';
            containers.produtos.appendChild(table);
        }
        
        async function carregarCategorias() {
            containers.categorias.innerHTML = '<p>Carregando categorias...</p>';
            const categorias = await apiRequest('/api/categorias');
             if (!categorias) { containers.categorias.innerHTML = '<p class="text-danger">Não foi possível carregar as categorias.</p>'; return; }
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Ordem</th><th>Permite Adicionais</th><th class="text-end">Ações</th></tr></thead><tbody>${categorias.map(c => `<tr data-categoria='${JSON.stringify(c)}'><td>${c.nome}</td><td>${c.ordem}</td><td>${c.permite_adicionais ? 'Sim' : 'Não'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-categoria"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-categoria" data-id="${c.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            containers.categorias.innerHTML = '';
            containers.categorias.appendChild(table);
        }

        async function carregarIngredientes() {
            containers.adicionais.innerHTML = '<p>Carregando...</p>';
            containers.ingredientesPreparo.innerHTML = '<p>Carregando...</p>';
            const todosOsItens = await apiRequest('/api/ingredientes');
            if (!todosOsItens) {
                containers.adicionais.innerHTML = '<p class="text-danger">Erro ao carregar itens.</p>';
                containers.ingredientesPreparo.innerHTML = '<p class="text-danger">Erro ao carregar itens.</p>';
                return;
            }
            const adicionais = todosOsItens.filter(item => item.pode_ser_adicional);
            const ingredientesDePreparo = todosOsItens.filter(item => !item.pode_ser_adicional);
            renderizarTabelaItens(adicionais, containers.adicionais, true);
            renderizarTabelaItens(ingredientesDePreparo, containers.ingredientesPreparo, false);
        }

        function renderizarTabelaItens(itens, container, ehAdicional) {
            if (itens.length === 0) { container.innerHTML = `<p class="text-muted">Nenhum item encontrado.</p>`; return; }
            const precoHeader = ehAdicional ? '<th>Preço</th>' : '';
            const precoBody = (item) => ehAdicional ? `<td>${parseFloat(item.preco_adicional || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>` : '';
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Estoque</th>${precoHeader}<th class="text-end">Ações</th></tr></thead><tbody>${itens.map(item => `<tr data-ingrediente='${JSON.stringify(item)}'><td>${item.nome} <small class="text-muted">(${item.unidade || 'N/A'})</small></td><td>${item.quantidade_estoque}</td>${precoBody(item)}<td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-ingrediente"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-ingrediente" data-id="${item.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        async function abrirModalProduto(p=null){document.getElementById('form-produto').reset();const s=document.getElementById('produto-categoria');s.innerHTML='<option>Carregando...</option>';const c=await apiRequest('/api/categorias');if(c)s.innerHTML=c.map(cat=>`<option value="${cat.id}">${cat.nome}</option>`).join('');if(p){document.getElementById('modalProdutoTitle').textContent='Editar Produto';document.getElementById('produto-id').value=p.id;document.getElementById('produto-nome').value=p.nome;document.getElementById('produto-descricao').value=p.descricao;document.getElementById('produto-preco').value=p.preco_base;document.getElementById('produto-categoria').value=p.categorias.id;document.getElementById('produto-imagem').value=p.imagem_url}else{document.getElementById('modalProdutoTitle').textContent='Adicionar Produto';document.getElementById('produto-id').value=''}modalProduto.show()};
        function abrirModalCategoria(c=null){const f=document.getElementById('form-categoria');f.reset();if(c){document.getElementById('modalCategoriaTitle').textContent='Editar Categoria';document.getElementById('categoria-id').value=c.id;document.getElementById('categoria-nome').value=c.nome;document.getElementById('categoria-ordem').value=c.ordem;document.getElementById('categoria-permite-adicionais').checked=c.permite_adicionais}else{document.getElementById('modalCategoriaTitle').textContent='Adicionar Categoria';document.getElementById('categoria-id').value=''}modalCategoria.show()};
        function abrirModalIngrediente(i=null){const f=document.getElementById('form-ingrediente');f.reset();const c=document.getElementById('campos-adicional');if(i){document.getElementById('modalIngredienteTitle').textContent='Editar Ingrediente';document.getElementById('ingrediente-id').value=i.id;document.getElementById('ingrediente-nome').value=i.nome;document.getElementById('ingrediente-unidade').value=i.unidade||'';document.getElementById('ingrediente-estoque').value=i.quantidade_estoque;document.getElementById('ingrediente-pode-adicional').checked=i.pode_ser_adicional;document.getElementById('ingrediente-preco-adicional').value=i.preco_adicional||0;document.getElementById('ingrediente-desconto-uso').value=i.quantidade_descontada||1}else{document.getElementById('modalIngredienteTitle').textContent='Adicionar Ingrediente';document.getElementById('ingrediente-id').value='';document.getElementById('ingrediente-desconto-uso').value=1}c.style.display=document.getElementById('ingrediente-pode-adicional').checked?'block':'none';modalIngrediente.show()};
        
        document.getElementById('ingrediente-pode-adicional').addEventListener('change',e=>{document.getElementById('campos-adicional').style.display=e.target.checked?'block':'none'});
        
        document.getElementById('form-produto').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('produto-id').value,p={nome:document.getElementById('produto-nome').value,descricao:document.getElementById('produto-descricao').value,preco_base:parseFloat(document.getElementById('produto-preco').value),categoria_id:parseInt(document.getElementById('produto-categoria').value),imagem_url:document.getElementById('produto-imagem').value};const r=id?await apiRequest(`/api/produtos/${id}`,'PUT',p):await apiRequest('/api/produtos','POST',p);if(r){modalProduto.hide();carregarProdutos()}});
        document.getElementById('form-categoria').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('categoria-id').value,c={nome:document.getElementById('categoria-nome').value,ordem:parseInt(document.getElementById('categoria-ordem').value),permite_adicionais:document.getElementById('categoria-permite-adicionais').checked};const r=id?await apiRequest(`/api/categorias/${id}`,'PUT',c):await apiRequest('/api/categorias','POST',c);if(r){modalCategoria.hide();carregarCategorias()}});
        document.getElementById('form-ingrediente').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('ingrediente-id').value,i={nome:document.getElementById('ingrediente-nome').value,unidade:document.getElementById('ingrediente-unidade').value,quantidade_estoque:parseInt(document.getElementById('ingrediente-estoque').value),pode_ser_adicional:document.getElementById('ingrediente-pode-adicional').checked,preco_adicional:parseFloat(document.getElementById('ingrediente-preco-adicional').value||0),quantidade_descontada:parseInt(document.getElementById('ingrediente-desconto-uso').value||1)};const r=id?await apiRequest(`/api/ingredientes/${id}`,'PUT',i):await apiRequest('/api/ingredientes','POST',i);if(r){modalIngrediente.hide();carregarIngredientes()}});
        
        document.body.addEventListener('click',async e=>{
            const bP=e.target.closest('.btn-editar-produto'),dX=e.target.closest('.btn-excluir-produto');
            const bI=e.target.closest('.btn-editar-ingrediente'),dI=e.target.closest('.btn-excluir-ingrediente');
            const bC=e.target.closest('.btn-editar-categoria'),dC=e.target.closest('.btn-excluir-categoria');
            if(bP)abrirModalProduto(JSON.parse(bP.closest('tr').dataset.produto));
            if(dX){const i=dX.dataset.id,n=dX.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/produtos/${i}`,'DELETE');carregarProdutos()}}
            if(bI)abrirModalIngrediente(JSON.parse(bI.closest('tr').dataset.ingrediente));
            if(dI){const i=dI.dataset.id,n=dI.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/ingredientes/${i}`,'DELETE');carregarIngredientes()}}
            if(bC)abrirModalCategoria(JSON.parse(bC.closest('tr').dataset.categoria));
            if(dC){const i=dC.dataset.id,n=dC.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/categorias/${i}`,'DELETE');carregarCategorias()}}
        });

        document.getElementById('btn-adicionar-produto').addEventListener('click',()=>abrirModalProduto());
        document.getElementById('btn-adicionar-categoria').addEventListener('click',()=>abrirModalCategoria());
        document.getElementById('btn-adicionar-ingrediente').addEventListener('click',()=>abrirModalIngrediente());
        
        document.getElementById('pedidos-tab').addEventListener('shown.bs.tab',carregarPedidos);
        document.getElementById('produtos-tab').addEventListener('shown.bs.tab',carregarProdutos);
        document.getElementById('categorias-tab').addEventListener('shown.bs.tab',carregarCategorias);
        document.getElementById('ingredientes-tab').addEventListener('shown.bs.tab',carregarIngredientes);

        document.getElementById('btn-recarregar-pedidos').addEventListener('click',carregarPedidos);
        carregarPedidos();
    });
    </script>
</body>
</html>
