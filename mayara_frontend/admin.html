<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Mayara Burguer's</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header { background-color: #343a40; color: white; padding: 1.5rem; text-align: center; }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { color: #000; font-weight: bold; border-color: #dee2e6 #dee2e6 #fff; }
        .tab-content { background-color: #fff; padding: 1rem; border: 1px solid #dee2e6; border-top: 0; }
        .btn-acao { width: 38px; height: 38px; }
        .form-check-input { width: 1.5em; height: 1.5em; }
        .sub-header { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        #lista-receita-edicao li, .lista-opcoes-grupo li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background-color: #f1f1f1; border-radius: 0.25rem;}
        .nav-pills .nav-link { text-align: left; }
    </style>
</head>
<body>

    <header class="header">
        <h1><i class="fas fa-cogs"></i> Painel de Controle</h1>
    </header>

    <main class="container my-4">
        <ul class="nav nav-tabs" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos-pane" type="button"><i class="fas fa-receipt"></i> Pedidos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="cadastros-tab" data-bs-toggle="tab" data-bs-target="#cadastros-pane" type="button"><i class="fas fa-edit"></i> Cadastros</button></li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <div class="tab-pane fade show active" id="pedidos-pane" role="tabpanel">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Histórico de Pedidos</h2><button id="btn-recarregar-pedidos" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync-alt"></i> Recarregar</button></div>
                    <div id="pedidos-container"><p>Carregando...</p></div>
                </div>
            </div>

            <div class="tab-pane fade" id="cadastros-pane" role="tabpanel">
                <div class="row p-2">
                    <div class="col-md-3">
                        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <button class="nav-link active" id="sub-produtos-pill" data-bs-toggle="pill" data-bs-target="#sub-produtos-pane" type="button"><i class="fas fa-hamburger fa-fw me-2"></i>Produtos</button>
                            <button class="nav-link" id="sub-categorias-pill" data-bs-toggle="pill" data-bs-target="#sub-categorias-pane" type="button"><i class="fas fa-tags fa-fw me-2"></i>Categorias</button>
                            <button class="nav-link" id="sub-grupos-opcoes-pill" data-bs-toggle="pill" data-bs-target="#sub-grupos-opcoes-pane" type="button"><i class="fas fa-layer-group fa-fw me-2"></i>Grupos de Opções</button>
                            <button class="nav-link" id="sub-insumos-pill" data-bs-toggle="pill" data-bs-target="#sub-insumos-pane" type="button"><i class="fas fa-carrot fa-fw me-2"></i>Insumos</button>
                            <button class="nav-link" id="sub-receitas-pill" data-bs-toggle="pill" data-bs-target="#sub-receitas-pane" type="button"><i class="fas fa-book-open fa-fw me-2"></i>Receitas</button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content" id="v-pills-tabContent">
                            <div class="tab-pane fade show active" id="sub-produtos-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Gerenciar Produtos</h2><button id="btn-adicionar-produto" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Produto</button></div>
                                <div id="produtos-container" class="table-responsive"></div>
                            </div>
                            <div class="tab-pane fade" id="sub-categorias-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Gerenciar Categorias</h2><button id="btn-adicionar-categoria" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Categoria</button></div>
                                <div id="categorias-container" class="table-responsive"></div>
                            </div>
                             <div class="tab-pane fade" id="sub-grupos-opcoes-pane" role="tabpanel">
                                 <h2 class="h4 mb-3">Gerenciar Grupos de Opções</h2>
                                 <div id="grupos-opcoes-accordion"></div>
                                 <hr>
                                 <h5 class="h6">Criar Novo Grupo</h5>
                                 <div class="input-group"><input type="text" id="input-novo-grupo" class="form-control" placeholder="Nome do novo grupo (ex: Tamanho da Pizza)"><button id="btn-add-novo-grupo" class="btn btn-success">Criar</button></div>
                            </div>
                            <div class="tab-pane fade" id="sub-insumos-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3"><h2 class="h4">Gerenciar Insumos</h2><button id="btn-adicionar-ingrediente" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Novo Item</button></div>
                                <h5 class="sub-header">Adicionais (Vendidos Separadamente)</h5>
                                <div id="adicionais-container" class="table-responsive mb-5"></div>
                                <h5 class="sub-header">Ingredientes de Preparo (Estoque Interno)</h5>
                                <div id="ingredientes-preparo-container" class="table-responsive"></div>
                            </div>
                            <div class="tab-pane fade" id="sub-receitas-pane" role="tabpanel">
                                <h2 class="h4 mb-3">Gerenciar Receitas</h2>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="receita-produto-select" class="form-label"><strong>Selecione um Produto para Editar a Receita</strong></label>
                                            <select id="receita-produto-select" class="form-select"></select>
                                        </div>
                                        <div id="receita-editor-container" style="display: none;">
                                            <hr>
                                            <h6 class="mb-3">Composição do Produto</h6>
                                            <div class="card bg-light p-3">
                                                <div class="row align-items-end">
                                                    <div class="col-md-6"><label for="receita-ingrediente-select" class="form-label">Insumo</label><select id="receita-ingrediente-select" class="form-select"></select></div>
                                                    <div class="col-md-4"><label for="receita-quantidade-input" class="form-label">Quantidade</label><input type="number" id="receita-quantidade-input" class="form-control" value="1" step="1"></div>
                                                    <div class="col-md-2"><button type="button" id="btn-add-ingrediente-receita" class="btn btn-primary w-100">Add</button></div>
                                                </div>
                                                <ul id="lista-receita-edicao" class="list-unstyled mt-3"></ul>
                                            </div>
                                            <button type="button" id="btn-salvar-receita" class="btn btn-success mt-3"><i class="fas fa-save"></i> Salvar Receita</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><form id="form-produto"><div class="modal-header"><h5 class="modal-title" id="modalProdutoTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="produto-id"><div class="row"><div class="col-md-8"><div class="mb-3"><label for="produto-nome" class="form-label">Nome</label><input type="text" class="form-control" id="produto-nome" required></div></div><div class="col-md-4"><div class="mb-3"><label for="produto-preco" class="form-label">Preço Base (R$)</label><input type="number" step="0.01" class="form-control" id="produto-preco" required><small class="form-text text-muted">Para produtos com opções, este campo é ignorado.</small></div></div></div><div class="mb-3"><label for="produto-descricao" class="form-label">Descrição</label><textarea class="form-control" id="produto-descricao"></textarea></div><div class="row"><div class="col-md-6 mb-3"><label for="produto-categoria" class="form-label">Categoria</label><select class="form-select" id="produto-categoria" required></select></div><div class="col-md-6 mb-3"><label for="produto-imagem" class="form-label">URL da Imagem</label><input type="url" class="form-control" id="produto-imagem"></div></div><div id="produto-opcoes-container"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>
    <div class="modal fade" id="modalCategoria" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="form-categoria"><div class="modal-header"><h5 class="modal-title" id="modalCategoriaTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="categoria-id"><div class="mb-3"><label for="categoria-nome" class="form-label">Nome da Categoria</label><input type="text" class="form-control" id="categoria-nome" required></div><div class="mb-3"><label for="categoria-ordem" class="form-label">Ordem de Exibição</label><input type="number" class="form-control" id="categoria-ordem" required></div><div class="mb-3"><label for="categoria-grupo-opcoes" class="form-label">Grupo de Opções (Subdivisão)</label><select class="form-select" id="categoria-grupo-opcoes"></select><small class="form-text text-muted">Associe um grupo de opções a esta categoria.</small></div><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" role="switch" id="categoria-permite-adicionais"><label class="form-check-label" for="categoria-permite-adicionais">Permitir Adicionais?</label></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>
    <div class="modal fade" id="modalIngrediente" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="form-ingrediente"><div class="modal-header"><h5 class="modal-title" id="modalIngredienteTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="ingrediente-id"><div class="mb-3"><label for="ingrediente-nome" class="form-label">Nome</label><input type="text" class="form-control" id="ingrediente-nome" required></div><div class="row"><div class="col-md-6 mb-3"><label for="ingrediente-unidade" class="form-label">Unidade</label><input type="text" class="form-control" id="ingrediente-unidade"></div><div class="col-md-6 mb-3"><label for="ingrediente-estoque" class="form-label">Estoque</label><input type="number" class="form-control" id="ingrediente-estoque" required></div></div><hr><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="ingrediente-pode-adicional"><label class="form-check-label" for="ingrediente-pode-adicional">É Adicional?</label></div><div id="campos-adicional" style="display:none;"><div class="row"><div class="col-md-6 mb-3"><label for="ingrediente-preco-adicional" class="form-label">Preço Adicional (R$)</label><input type="number" step="0.01" class="form-control" id="ingrediente-preco-adicional"></div><div class="col-md-6 mb-3"><label for="ingrediente-desconto-uso" class="form-label">Desconto Estoque</label><input type="number" step="1" class="form-control" id="ingrediente-desconto-uso"><small class="form-text text-muted">Qtd. por uso.</small></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const BASE_URL = 'https://mayara-backend-servidor.onrender.com';
        const modalProduto = new bootstrap.Modal(document.getElementById('modalProduto'));
        const modalIngrediente = new bootstrap.Modal(document.getElementById('modalIngrediente'));
        const modalCategoria = new bootstrap.Modal(document.getElementById('modalCategoria'));
        
        const containers = {
            pedidos: document.getElementById('pedidos-container'),
            produtos: document.getElementById('produtos-container'),
            categorias: document.getElementById('categorias-container'),
            adicionais: document.getElementById('adicionais-container'),
            ingredientesPreparo: document.getElementById('ingredientes-preparo-container')
        };

        let receitaEmEdicao = [], todosOsIngredientes = [], todosOsProdutos = [], todasAsCategorias = [], todosOsGruposOpcoes = [];
        let produtoSelecionadoParaReceita = null;
        
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`${BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    throw new Error(errorData.error || `Erro na rede: ${response.statusText}`);
                }
                if (response.status === 204) return { success: true };
                return await response.json();
            } catch (error) {
                console.error(`Falha na requisição para ${endpoint}:`, error);
                alert(`Erro: ${error.message}`);
                return null;
            }
        }

        async function carregarDadosIniciais() {
            const resultados = await Promise.all([
                apiRequest('/api/ingredientes'),
                apiRequest('/api/produtos'),
                apiRequest('/api/categorias'),
                apiRequest('/api/grupos_opcoes')
            ]);
            todosOsIngredientes = resultados[0] || [];
            todosOsProdutos = resultados[1] || [];
            todasAsCategorias = resultados[2] || [];
            todosOsGruposOpcoes = resultados[3] || [];
        }
        
        async function carregarPedidos() {
            containers.pedidos.innerHTML = '<p>Carregando histórico de pedidos...</p>';
            const pedidos = await apiRequest('/api/pedidos');
            if (!pedidos) { containers.pedidos.innerHTML = '<p class="text-danger">Não foi possível carregar os pedidos.</p>'; return; }
            if (pedidos.length === 0) { containers.pedidos.innerHTML = '<p class="text-muted">Nenhum pedido encontrado.</p>'; return; }
            containers.pedidos.innerHTML = '';
            pedidos.forEach(pedido => {
                const dataHora = new Date(pedido.data_hora).toLocaleString('pt-BR');
                const valorTotal = parseFloat(pedido.valor_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                let itensHtml = (pedido.itens_do_pedido && pedido.itens_do_pedido.length > 0) ? `<ul>${pedido.itens_do_pedido.map(item => `<li>${item.quantidade}x ${item.nome_produto} ${item.observacoes ? `<em>(${item.observacoes})</em>` : ''}</li>`).join('')}</ul>` : '<p class="small text-muted">Sem detalhes de itens.</p>';
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `<div class="card-header d-flex justify-content-between"><strong>Pedido #${pedido.id}</strong><span class="text-muted">${dataHora}</span></div><div class="card-body"><p class="mb-1"><strong>Cliente:</strong> ${pedido.cliente_nome}</p><p class="mb-1"><strong>Endereço:</strong> ${pedido.tipo_entrega === 'delivery' ? pedido.cliente_endereco : 'Retirada no Balcão'}</p><hr><h6>Itens:</h6>${itensHtml}</div><div class="card-footer text-end"><strong>Total: ${valorTotal}</strong></div>`;
                containers.pedidos.appendChild(card);
            });
        }
        
        async function carregarProdutos() {
            containers.produtos.innerHTML = '<p>Carregando produtos...</p>';
             if (!todosOsProdutos) { containers.produtos.innerHTML = '<p class="text-danger">Não foi possível carregar os produtos.</p>'; return; }
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Categoria</th><th>Preço Base</th><th class="text-end">Ações</th></tr></thead><tbody>${todosOsProdutos.map(p => `<tr data-produto='${JSON.stringify(p)}'><td>${p.nome}</td><td>${p.categorias.nome}</td><td>${parseFloat(p.preco_base).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-produto"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-produto" data-id="${p.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            containers.produtos.innerHTML = '';
            containers.produtos.appendChild(table);
        }
        
        async function carregarCategorias() {
            containers.categorias.innerHTML = '<p>Carregando categorias...</p>';
            if (!todasAsCategorias) { containers.categorias.innerHTML = '<p class="text-danger">Não foi possível carregar as categorias.</p>'; return; }
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Ordem</th><th>Permite Adicionais</th><th class="text-end">Ações</th></tr></thead><tbody>${todasAsCategorias.map(c => `<tr data-categoria='${JSON.stringify(c)}'><td>${c.nome}</td><td>${c.ordem}</td><td>${c.permite_adicionais ? 'Sim' : 'Não'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-categoria"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-categoria" data-id="${c.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            containers.categorias.innerHTML = '';
            containers.categorias.appendChild(table);
        }

        async function carregarIngredientes() {
            containers.adicionais.innerHTML = '<p>Carregando...</p>';
            containers.ingredientesPreparo.innerHTML = '<p>Carregando...</p>';
            if (!todosOsIngredientes) {
                containers.adicionais.innerHTML = '<p class="text-danger">Erro ao carregar itens.</p>';
                containers.ingredientesPreparo.innerHTML = '<p class="text-danger">Erro ao carregar itens.</p>';
                return;
            }
            const adicionais = todosOsIngredientes.filter(item => item.pode_ser_adicional);
            const ingredientesDePreparo = todosOsIngredientes.filter(item => !item.pode_ser_adicional);
            renderizarTabelaItens(adicionais, containers.adicionais, true);
            renderizarTabelaItens(ingredientesDePreparo, containers.ingredientesPreparo, false);
        }

        function renderizarTabelaItens(itens, container, ehAdicional) {
            if (itens.length === 0) { container.innerHTML = `<p class="text-muted">Nenhum item encontrado.</p>`; return; }
            const precoHeader = ehAdicional ? '<th>Preço</th>' : '';
            const precoBody = (item) => ehAdicional ? `<td>${parseFloat(item.preco_adicional || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>` : '';
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle';
            table.innerHTML = `<thead><tr><th>Nome</th><th>Estoque</th>${precoHeader}<th class="text-end">Ações</th></tr></thead><tbody>${itens.map(item => `<tr data-ingrediente='${JSON.stringify(item)}'><td>${item.nome} <small class="text-muted">(${item.unidade || 'N/A'})</small></td><td>${item.quantidade_estoque}</td>${precoBody(item)}<td class="text-end"><button class="btn btn-sm btn-outline-primary btn-acao btn-editar-ingrediente"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger btn-acao btn-excluir-ingrediente" data-id="${item.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        async function carregarReceitas() {
            const selectProduto = document.getElementById('receita-produto-select');
            selectProduto.innerHTML = '<option value="">Selecione um produto...</option>';
            todosOsProdutos.forEach(p => {
                selectProduto.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });
            document.getElementById('receita-editor-container').style.display = 'none';
            receitaEmEdicao = [];
            produtoSelecionadoParaReceita = null;
        }

        async function carregarGruposOpcoes() {
            const accordionContainer = document.getElementById('grupos-opcoes-accordion');
            accordionContainer.innerHTML = '<p>Carregando...</p>';
            if (todosOsGruposOpcoes.length === 0) {
                accordionContainer.innerHTML = '<p class="text-muted">Nenhum grupo de opções criado.</p>';
                return;
            }
            accordionContainer.innerHTML = todosOsGruposOpcoes.map((grupo, index) => `
                <div class="accordion-item"><h2 class="accordion-header" id="heading-${index}"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${index}">${grupo.nome}</button></h2><div id="collapse-${index}" class="accordion-collapse collapse" data-bs-parent="#grupos-opcoes-accordion"><div class="accordion-body"><button class="btn btn-sm btn-outline-danger float-end btn-excluir-grupo" data-id="${grupo.id}">Excluir Grupo</button><strong>Opções:</strong><ul class="list-unstyled mt-2 lista-opcoes-grupo">${grupo.opcoes.map(opt => `<li><span>${opt.nome}</span><button class="btn btn-sm btn-danger btn-excluir-opcao" data-id="${opt.id}"><i class="fas fa-times"></i></button></li>`).join('')}</ul><div class="input-group mt-3"><input type="text" class="form-control input-nova-opcao" placeholder="Nome da nova opção"><button class="btn btn-primary btn-add-nova-opcao" data-grupo-id="${grupo.id}">Adicionar Opção</button></div></div></div></div>`).join('');
        }
        
        async function abrirModalProduto(produto = null) {
            document.getElementById('form-produto').reset();
            const selectCategoria = document.getElementById('produto-categoria');
            selectCategoria.innerHTML = '<option value="">Selecione...</option>';
            todasAsCategorias.forEach(c => {
                selectCategoria.innerHTML += `<option value="${c.id}" data-grupo-id="${c.grupo_opcoes_id || ''}">${c.nome}</option>`;
            });
            if (produto) {
                document.getElementById('modalProdutoTitle').textContent = 'Editar Produto';
                document.getElementById('produto-id').value = produto.id;
                document.getElementById('produto-nome').value = produto.nome;
                document.getElementById('produto-descricao').value = produto.descricao;
                document.getElementById('produto-preco').value = produto.preco_base;
                selectCategoria.value = produto.categorias.id;
                document.getElementById('produto-imagem').value = produto.imagem_url;
                await atualizarOpcoesProduto(produto.categorias.id, produto.id);
            } else {
                document.getElementById('modalProdutoTitle').textContent = 'Adicionar Produto';
                document.getElementById('produto-id').value = '';
                document.getElementById('produto-opcoes-container').innerHTML = '';
            }
            modalProduto.show();
        }

        async function atualizarOpcoesProduto(categoriaId, produtoId = null) {
            const container = document.getElementById('produto-opcoes-container');
            container.innerHTML = '';
            const categoria = todasAsCategorias.find(c => c.id == categoriaId);
            if (!categoria || !categoria.grupo_opcoes_id) return;
            const grupo = todosOsGruposOpcoes.find(g => g.id == categoria.grupo_opcoes_id);
            if (!grupo) return;
            let precosSalvos = {};
            if (produtoId) {
                const produtoComOpcoes = await apiRequest(`/api/produtos/${produtoId}/opcoes`);
                if (produtoComOpcoes && produtoComOpcoes.opcoes) {
                    produtoComOpcoes.opcoes.forEach(opt => { precosSalvos[opt.id] = opt.preco; });
                }
            }
            let html = `<hr class="my-4"><h6 class="mb-3">Preços para Opções de "${grupo.nome}"</h6>`;
            grupo.opcoes.forEach(opt => {
                const preco = precosSalvos[opt.id] || '0.00';
                html += `<div class="input-group mb-2"><span class="input-group-text" style="width: 150px;">${opt.nome}</span><span class="input-group-text">R$</span><input type="number" step="0.01" class="form-control" data-opcao-id="${opt.id}" value="${preco}"></div>`;
            });
            container.innerHTML = html;
        }

        function abrirModalCategoria(categoria = null) {
            const form = document.getElementById('form-categoria');
            form.reset();
            const selectGrupo = document.getElementById('categoria-grupo-opcoes');
            selectGrupo.innerHTML = '<option value="">Nenhum</option>';
            todosOsGruposOpcoes.forEach(g => {
                selectGrupo.innerHTML += `<option value="${g.id}">${g.nome}</option>`;
            });
            if (categoria) {
                document.getElementById('modalCategoriaTitle').textContent = 'Editar Categoria';
                document.getElementById('categoria-id').value = categoria.id;
                document.getElementById('categoria-nome').value = categoria.nome;
                document.getElementById('categoria-ordem').value = categoria.ordem;
                document.getElementById('categoria-permite-adicionais').checked = categoria.permite_adicionais;
                selectGrupo.value = categoria.grupo_opcoes_id || '';
            } else {
                document.getElementById('modalCategoriaTitle').textContent = 'Adicionar Categoria';
                document.getElementById('categoria-id').value = '';
            }
            modalCategoria.show();
        }
        
        function abrirModalIngrediente(ingrediente = null){
            const form = document.getElementById('form-ingrediente');
            form.reset();
            const camposAdicional = document.getElementById('campos-adicional');
            if(ingrediente){
                document.getElementById('modalIngredienteTitle').textContent = 'Editar Ingrediente';
                document.getElementById('ingrediente-id').value = ingrediente.id;
                document.getElementById('ingrediente-nome').value = ingrediente.nome;
                document.getElementById('ingrediente-unidade').value = ingrediente.unidade || '';
                document.getElementById('ingrediente-estoque').value = ingrediente.quantidade_estoque;
                document.getElementById('ingrediente-pode-adicional').checked = ingrediente.pode_ser_adicional;
                document.getElementById('ingrediente-preco-adicional').value = ingrediente.preco_adicional || 0;
                document.getElementById('ingrediente-desconto-uso').value = ingrediente.quantidade_descontada || 1;
            } else {
                document.getElementById('modalIngredienteTitle').textContent = 'Adicionar Ingrediente';
                document.getElementById('ingrediente-id').value = '';
                document.getElementById('ingrediente-desconto-uso').value = 1;
            }
            camposAdicional.style.display = document.getElementById('ingrediente-pode-adicional').checked ? 'block' : 'none';
            modalIngrediente.show();
        }

        document.getElementById('produto-categoria').addEventListener('change', (e) => {
            const produtoId = document.getElementById('produto-id').value;
            atualizarOpcoesProduto(e.target.value, produtoId || null);
        });
        document.getElementById('ingrediente-pode-adicional').addEventListener('change',e=>{document.getElementById('campos-adicional').style.display=e.target.checked?'block':'none'});
        
        document.getElementById('form-produto').addEventListener('submit',async e=>{ e.preventDefault(); const id=document.getElementById('produto-id').value; let opcoes = []; document.querySelectorAll('#produto-opcoes-container input').forEach(input => {opcoes.push({opcao_id: parseInt(input.dataset.opcaoId),preco: parseFloat(input.value)})}); const p={nome:document.getElementById('produto-nome').value,descricao:document.getElementById('produto-descricao').value,preco_base:parseFloat(document.getElementById('produto-preco').value),categoria_id:parseInt(document.getElementById('produto-categoria').value),imagem_url:document.getElementById('produto-imagem').value,opcoes:opcoes}; const r=id?await apiRequest(`/api/produtos/${id}`,'PUT',p):await apiRequest('/api/produtos','POST',p); if(r){ modalProduto.hide(); await carregarDadosIniciais(); carregarProdutos(); } });
        document.getElementById('form-categoria').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('categoria-id').value,c={nome:document.getElementById('categoria-nome').value,ordem:parseInt(document.getElementById('categoria-ordem').value),permite_adicionais:document.getElementById('categoria-permite-adicionais').checked,grupo_opcoes_id:parseInt(document.getElementById('categoria-grupo-opcoes').value)||null};const r=id?await apiRequest(`/api/categorias/${id}`,'PUT',c):await apiRequest('/api/categorias','POST',c);if(r){modalCategoria.hide();await carregarDadosIniciais();carregarCategorias()}});
        document.getElementById('form-ingrediente').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('ingrediente-id').value,i={nome:document.getElementById('ingrediente-nome').value,unidade:document.getElementById('ingrediente-unidade').value,quantidade_estoque:parseInt(document.getElementById('ingrediente-estoque').value),pode_ser_adicional:document.getElementById('ingrediente-pode-adicional').checked,preco_adicional:parseFloat(document.getElementById('ingrediente-preco-adicional').value||0),quantidade_descontada:parseInt(document.getElementById('ingrediente-desconto-uso').value||1)};const r=id?await apiRequest(`/api/ingredientes/${id}`,'PUT',i):await apiRequest('/api/ingredientes','POST',i);if(r){modalIngrediente.hide();await carregarDadosIniciais();carregarIngredientes()}});
        
        document.getElementById('btn-add-receita').addEventListener('click',()=>{const i=parseInt(document.getElementById('receita-ingrediente-select').value),q=parseInt(document.getElementById('receita-quantidade-input').value),s=todosOsIngredientes.find(ing=>ing.id===i);if(i&&q>0&&s){if(!receitaEmEdicao.some(item=>item.ingrediente_id===i)){receitaEmEdicao.push({ingrediente_id:i,quantidade_usada:q,nome:s.nome});renderizarReceitaParaEdicao()}else{alert('Ingrediente já está na receita.')}}});
        document.getElementById('lista-receita-edicao').addEventListener('click',e=>{if(e.target.closest('.btn-remover-receita-edicao')){const i=parseInt(e.target.closest('.btn-remover-receita-edicao').dataset.index);receitaEmEdicao.splice(i,1);renderizarReceitaParaEdicao()}});
        document.getElementById('btn-salvar-receita').addEventListener('click',async()=>{if(!produtoSelecionadoParaReceita){alert('Nenhum produto selecionado.');return}const p=todosOsProdutos.find(prod=>prod.id===produtoSelecionadoParaReceita.id);const u={...p,receita:receitaEmEdicao.map(({ingrediente_id,quantidade_usada})=>({ingrediente_id,quantidade_usada}))};delete u.categorias;const r=await apiRequest(`/api/produtos/${produtoSelecionadoParaReceita.id}`,'PUT',u);if(r){alert('Receita salva com sucesso!')}});

        document.body.addEventListener('click',async e=>{
            const bP=e.target.closest('.btn-editar-produto'),dX=e.target.closest('.btn-excluir-produto');
            const bI=e.target.closest('.btn-editar-ingrediente'),dI=e.target.closest('.btn-excluir-ingrediente');
            const bC=e.target.closest('.btn-editar-categoria'),dC=e.target.closest('.btn-excluir-categoria');
            const bGrupo=e.target.closest('.btn-excluir-grupo'),bOpcao=e.target.closest('.btn-excluir-opcao'),bAddOpcao=e.target.closest('.btn-add-nova-opcao');
            if(bP)abrirModalProduto(JSON.parse(bP.closest('tr').dataset.produto));
            if(dX){const i=dX.dataset.id,n=dX.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/produtos/${i}`,'DELETE');await carregarDadosIniciais();carregarProdutos()}}
            if(bI)abrirModalIngrediente(JSON.parse(bI.closest('tr').dataset.ingrediente));
            if(dI){const i=dI.dataset.id,n=dI.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/ingredientes/${i}`,'DELETE');await carregarDadosIniciais();carregarIngredientes()}}
            if(bC)abrirModalCategoria(JSON.parse(bC.closest('tr').dataset.categoria));
            if(dC){const i=dC.dataset.id,n=dC.closest('tr').cells[0].textContent;if(confirm(`Excluir "${n}"?`)){await apiRequest(`/api/categorias/${i}`,'DELETE');await carregarDadosIniciais();carregarCategorias()}}
            if(bGrupo){const i=bGrupo.dataset.id;if(confirm('Excluir este grupo e todas as suas opções?')){await apiRequest(`/api/grupos_opcoes/${i}`,'DELETE');await carregarDadosIniciais();carregarGruposOpcoes()}}
            if(bOpcao){const i=bOpcao.dataset.id;if(confirm('Excluir esta opção?')){await apiRequest(`/api/opcoes/${i}`,'DELETE');await carregarDadosIniciais();carregarGruposOpcoes()}}
            if(bAddOpcao){const i=bAddOpcao.dataset.grupoId;const n=bAddOpcao.previousElementSibling.value.trim();if(n){await apiRequest('/api/opcoes','POST',{grupo_id:i,nome:n});await carregarDadosIniciais();carregarGruposOpcoes();bAddOpcao.previousElementSibling.value=''}}
        });

        document.getElementById('btn-add-novo-grupo').addEventListener('click', async () => {
            const nome = document.getElementById('input-novo-grupo').value.trim();
            if(nome) { await apiRequest('/api/grupos_opcoes', 'POST', { nome }); await carregarDadosIniciais(); carregarGruposOpcoes(); document.getElementById('input-novo-grupo').value = ''; }
        });
        document.getElementById('btn-adicionar-produto').addEventListener('click',()=>abrirModalProduto());
        document.getElementById('btn-adicionar-categoria').addEventListener('click',()=>abrirModalCategoria());
        document.getElementById('btn-adicionar-ingrediente').addEventListener('click',()=>abrirModalIngrediente());
        
        document.getElementById('pedidos-tab').addEventListener('shown.bs.tab',carregarPedidos);
        document.getElementById('btn-recarregar-pedidos').addEventListener('click',carregarPedidos);
        document.getElementById('cadastros-tab').addEventListener('shown.bs.tab', carregarProdutos);
        document.getElementById('sub-produtos-pill').addEventListener('shown.bs.tab', carregarProdutos);
        document.getElementById('sub-categorias-pill').addEventListener('shown.bs.tab', carregarCategorias);
        document.getElementById('sub-insumos-pill').addEventListener('shown.bs.tab', carregarIngredientes);
        document.getElementById('sub-receitas-pill').addEventListener('shown.bs.tab', carregarReceitas);
        document.getElementById('sub-grupos-opcoes-pill').addEventListener('shown.bs.tab', carregarGruposOpcoes);
        
        await carregarDadosIniciais();
        carregarPedidos();
    });
    </script>
</body>
</html>
